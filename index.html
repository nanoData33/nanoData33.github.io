<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistente Cl√≠nico ‚Äî Chat (Audio + Texto)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>
<style>
  :root{
    --azul:#2A4C9E; --cian:#009CDE; --violeta:#6A5ACD;
    --gris:#F5F7FA; --blanco:#FFFFFF; --texto:#1E1E2F; --sombra:rgba(0,0,0,0.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Poppins',sans-serif;background:var(--gris);display:flex;flex-direction:column;min-height:100vh}
  header{background:var(--azul);color:#fff;padding:16px 20px;text-align:center;font-weight:600}
  .wrap{width:95%;max-width:900px;margin:18px auto;display:flex;flex-direction:column;gap:12px}
  .chat-box{background:var(--blanco);border-radius:12px;box-shadow:0 6px 18px var(--sombra);padding:16px}
  .messages{height:420px;overflow:auto;background:#f9fbff;border-radius:8px;padding:12px;white-space:pre-wrap}
  .msg{margin:8px 0;padding:10px 12px;border-radius:10px;display:block}
  .msg.user{background:var(--cian);color:#fff;text-align:right}
  .msg.bot{background:#ebedff;color:#111;text-align:left}
  .controls{display:flex;gap:8px;margin-top:8px}
  input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc;outline:none}
  button{background:var(--azul);color:#fff;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
  button:hover{background:var(--violeta)}
  #recordBtn.recording{background:#b71c1c}
  .grafico-btn{background:var(--violeta);margin-top:8px;padding:8px 12px;border-radius:8px;border:none;color:#fff;cursor:pointer}
  table.md-table{border-collapse:collapse;width:100%;margin-top:8px}
  table.md-table th, table.md-table td{border:1px solid #ddd;padding:6px 8px;text-align:left}
  .meta-pre{background:#fff;border-radius:6px;padding:6px;margin:6px 0;font-size:0.9em;color:#333;white-space:pre-wrap}
  footer{padding:10px;text-align:center;color:#666;font-size:.9rem}
</style>
</head>
<body>
<header>üéôÔ∏è Asistente Cl√≠nico ‚Äî Test Audio & Texto</header>

<div class="wrap">
  <div class="chat-box">
    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="controls" style="margin-top:12px">
      <input id="userInput" type="text" placeholder="Escribe tu mensaje o graba audio..." />
      <button id="sendBtn" title="Enviar">Enviar</button>
      <button id="recordBtn" title="Grabar (micro)"><i data-lucide="mic"></i></button>
    </div>
  </div>
</div>

<footer>¬© 2025 Asistente Cl√≠nico ‚Äî Test Webhook Audio/Texto</footer>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
lucide.createIcons();

const WEBHOOK = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
const GRAFICO_WEBHOOK = "https://rubaseval.app.n8n.cloud/webhook-test/generargrafico";

const messagesDiv = document.getElementById('messages');
const input = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const recordBtn = document.getElementById('recordBtn');

let lastUserMessage = "";
let mediaRecorder = null;
let audioChunks = [];
let recording = false;

sendBtn.addEventListener('click', () => sendText());
input.addEventListener('keydown', e => { if (e.key === 'Enter') sendText(); });
recordBtn.addEventListener('click', toggleRecording);

function appendMessage(kind, html) {
  const d = document.createElement('div');
  d.className = 'msg ' + (kind === 'user' ? 'user' : 'bot');
  d.innerHTML = html;
  messagesDiv.appendChild(d);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  return d;
}

async function fetchAndParse(url, options) {
  const res = await fetch(url, options);
  const raw = await res.text();
  let parsed = null;
  try {
    parsed = JSON.parse(raw);
  } catch (e) {
    parsed = null;
  }
  return { raw, parsed };
}

async function sendText() {
  const text = input.value.trim();
  if (!text) return;
  lastUserMessage = text;
  appendMessage('user', escapeHtml(text));
  input.value = '';
  const loading = appendMessage('bot', '<em>Procesando...</em>');

  try {
    const { parsed } = await fetchAndParse(WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'text', content: text })
    });

    loading.remove();
    const data = parsed ?? { respuesta: 'Error: formato inv√°lido', mostrar_boton_grafico: false };

    // Mostrar solo el texto de respuesta
    if (data.respuesta) {
      const msgDiv = appendMessage('bot', renderRespuesta(data.respuesta));

      if (data.mostrar_boton_grafico === true || data.mostrar_boton_grafico === 'true') {
        const btn = document.createElement('button');
        btn.className = 'grafico-btn';
        btn.textContent = 'üìä Generar gr√°fico';
        btn.onclick = () => generarGrafico(data.respuesta, lastUserMessage, btn);
        msgDiv.appendChild(btn);
      }
    } else {
      appendMessage('bot', '<em>No se recibi√≥ respuesta v√°lida.</em>');
    }

  } catch (err) {
    loading.remove();
    appendMessage('bot', `‚ö†Ô∏è Error de conexi√≥n con el asistente.`);
    console.error(err);
  }
}

// Renderizar texto y tablas Markdown
function renderRespuesta(text) {
  // Buscar tabla markdown
  const lines = text.split(/\r?\n/);
  let tableStart = lines.findIndex(l => /^\s*\|/.test(l));
  if (tableStart === -1) return escapeHtml(text);

  const intro = lines.slice(0, tableStart).join('\n').trim();
  const tableLines = lines.slice(tableStart).filter(l => /^\s*\|/.test(l));

  const rows = tableLines.map(r => {
    let clean = r.trim();
    if (clean.startsWith('|')) clean = clean.slice(1);
    if (clean.endsWith('|')) clean = clean.slice(0, -1);
    return clean.split('|').map(c => c.trim());
  });

  if (rows.length < 2) return escapeHtml(text);

  const header = rows[0];
  if (rows[1].every(c => /^-+$/.test(c))) rows.splice(1, 1);

  let html = '';
  if (intro) html += `<div class="meta-pre">${escapeHtml(intro)}</div>`;
  html += `<table class="md-table"><thead><tr>${header.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr></thead><tbody>`;
  for (let i = 1; i < rows.length; i++) {
    html += `<tr>${rows[i].map(c => `<td>${escapeHtml(c)}</td>`).join('')}</tr>`;
  }
  html += '</tbody></table>';
  return html;
}

async function generarGrafico(respuesta, consulta, btnEl) {
  if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'Generando...'; }
  appendMessage('bot', '<em>Generando gr√°fico...</em>');
  try {
    const res = await fetch(GRAFICO_WEBHOOK, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ respuesta, consulta })
    });
    const raw = await res.text();
    appendMessage('bot', escapeHtml(raw));
  } catch (err) {
    appendMessage('bot', `‚ö†Ô∏è Error al generar gr√°fico.`);
    console.error(err);
  } finally {
    if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'üìä Generar gr√°fico'; }
  }
}

async function toggleRecording() {
  recording = !recording;
  recordBtn.classList.toggle('recording', recording);
  recordBtn.innerHTML = recording ? '<i data-lucide="square"></i>' : '<i data-lucide="mic"></i>';
  lucide.createIcons();
  if (recording) startRecording(); else stopRecording();
}

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: 'audio/webm' });
      appendMessage('user', '<i>Audio grabado enviado...</i>');
      const form = new FormData();
      form.append('type', 'audio');
      form.append('file', blob, 'voz.webm');
      try {
        const { parsed } = await fetchAndParse(WEBHOOK, { method: 'POST', body: form });
        const data = parsed ?? { respuesta: 'Error', mostrar_boton_grafico: false };
        appendMessage('bot', renderRespuesta(data.respuesta || 'Error'));
      } catch {
        appendMessage('bot', '‚ö†Ô∏è Error al subir audio.');
      }
    };
    mediaRecorder.start();
  } catch {
    appendMessage('bot', '‚ö†Ô∏è No se pudo acceder al micr√≥fono.');
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[c]));
}
</script>
</body>
</html>
