<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Cl√≠nico ‚Äì Audio y Texto</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --azul: #2A4C9E;
    --cian: #009CDE;
    --violeta: #6A5ACD;
    --gris: #F5F7FA;
    --blanco: #FFFFFF;
    --texto: #1E1E2F;
    --sombra: rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--gris);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: var(--azul);
    color: white;
    padding: 20px 40px;
    font-weight: 600;
    text-align: center;
  }

  main { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }
  .chat-box {
    width: 90%;
    max-width: 800px;
    background: var(--blanco);
    border-radius: 12px;
    box-shadow: 0 4px 10px var(--sombra);
    padding: 20px;
  }

  h2 { color: var(--azul); margin-bottom: 10px; text-align: center; }
  .messages {
    height: 300px;
    overflow-y: auto;
    background: #f9fbff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: inset 0 0 4px var(--sombra);
  }

  .msg { margin-bottom: 10px; padding: 10px 14px; border-radius: 10px; }
  .msg.user { background: var(--cian); color: white; text-align: right; }
  .msg.bot { background: #ebedff; color: #222; }

  .input-area {
    display: flex; align-items: center; gap: 10px;
  }
  input {
    flex: 1; padding: 10px 14px;
    border: 1px solid #ccc;
    border-radius: 10px;
    outline: none;
  }
  button {
    background: var(--azul);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 14px;
    cursor: pointer;
    transition: background 0.25s;
  }
  button:hover { background: var(--violeta); }
  #recordBtn.recording { background: #b71c1c; }
</style>
</head>
<body>
<header>üéôÔ∏è Asistente Cl√≠nico Inteligente ‚Äì Test Audio + Texto</header>

<main>
  <div class="chat-box">
    <h2>Prueba de env√≠o combinado a n8n</h2>
    <div id="messages" class="messages"></div>

    <div class="input-area">
      <input id="userInput" placeholder="Escribe tu mensaje o graba audio..." />
      <button id="recordBtn" onclick="toggleRecording()"><i data-lucide='mic'></i></button>
      <button onclick="sendText()"><i data-lucide='send'></i></button>
    </div>
  </div>
</main>

<footer>¬© 2025 Asistente Cl√≠nico ‚Äî Test Webhook Audio/Texto</footer>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
lucide.createIcons();

// === CONFIG ===
const webhook = "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio";
// --- NUEVO WEBHOOK ---
const graphWebhook = "https://rubaseval.app.n8n.cloud/webhook-test/generargrafico";

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("userInput");

let recording = false;
let mediaRecorder, audioChunks = [];

// === ENV√çO DE TEXTO ===
async function sendText() {
  const text = input.value.trim();
  if (!text) return;
  appendMessage("user", text);
  input.value = "";
  appendMessage("bot", "<em>Procesando texto...</em>", true);

  try {
    const res = await fetch(webhook, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "text",
        content: text
      })
    });

    const data = await res.text();
    removeLoading();
    appendMessage("bot", `<pre>${data}</pre>`);
  } catch (err) {
    removeLoading();
    appendMessage("bot", "‚ö†Ô∏è Error de conexi√≥n con el asistente.");
    console.error(err);
  }
}

// === GRABACI√ìN DE AUDIO ===
async function toggleRecording() {
  const btn = document.getElementById("recordBtn");
  recording = !recording;
  btn.classList.toggle("recording");
  btn.innerHTML = recording ? "<i data-lucide='square'></i>" : "<i data-lucide='mic'></i>";
  lucide.createIcons();

  if (recording) startRecording(); else stopRecording();
}

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      appendMessage("user", "<i>Audio grabado enviado...</i>");
      appendMessage("bot", "<em>Subiendo audio...</em>", true);

      const formData = new FormData();
      formData.append("type", "audio");
      formData.append("file", blob, "voz.webm");

      try {
        const res = await fetch(webhook, { method: "POST", body: formData });
        const data = await res.text();
        removeLoading();
        appendMessage("bot", `<pre>${data}</pre>`);
      } catch (err) {
        removeLoading();
        appendMessage("bot", "‚ö†Ô∏è Error al subir audio.");
        console.error(err);
      }
    };
    mediaRecorder.start();
  } catch (error) {
    appendMessage("bot", "‚ö†Ô∏è No se pudo acceder al micr√≥fono.");
  }
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
}

// === NUEVA FUNCI√ìN PARA GR√ÅFICO ===
async function sendGraphRequest(data) {
  appendMessage("bot", "<em>Generando gr√°fico...</em>", true);

  try {
    const res = await fetch(graphWebhook, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "graph_request",
        data: data // Env√≠a los datos de la respuesta anterior
      })
    });

    const responseData = await res.text(); 
    removeLoading();
    // A√±ade la respuesta (que podr√≠a ser un <img> o texto)
    appendMessage("bot", `Respuesta Gr√°fico: ${responseData}`);
  } catch (err) {
    removeLoading();
    appendMessage("bot", "‚ö†Ô∏è Error al generar gr√°fico.");
    console.error(err);
  }
}

// === MENSAJES (MODIFICADA) ===
function appendMessage(sender, html, isLoading=false) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;
  msg.innerHTML = html;
  if (isLoading) msg.id = "loading";
  messagesDiv.appendChild(msg);

  // --- MODIFICACI√ìN ---
  // Si es un mensaje del bot, no est√° cargando y no es un error, a√±adir bot√≥n
  if (sender === "bot" && !isLoading && !html.includes("‚ö†Ô∏è")) {
    const graphBtn = document.createElement("button");
    graphBtn.innerText = "Generar gr√°fico";
    
    // Aplicar estilos para que coincida con la UI
    graphBtn.style.background = "var(--violeta)";
    graphBtn.style.color = "white";
    graphBtn.style.border = "none";
    graphBtn.style.borderRadius = "10px";
    graphBtn.style.padding = "10px 14px";
    graphBtn.style.cursor = "pointer";
    graphBtn.style.marginTop = "10px";
    
    // Extraer datos crudos del tag <pre> para enviarlos
    const preData = html.replace(/<\/?pre>/g, '');
    
    graphBtn.onclick = () => sendGraphRequest(preData);
    
    msg.appendChild(graphBtn);
  }
  // --- FIN DE MODIFICACI√ìN ---

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeLoading() {
  const loading = document.getElementById("loading");
  if (loading) loading.remove();
}
</script>
</body>
</html>
