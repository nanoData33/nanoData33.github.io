<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Asistente Cl√≠nico ‚Äì Identificaci√≥n de Cohortes</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<style>
  :root {
    --azul: #2A4C9E;
    --cian: #009CDE;
    --violeta: #6A5ACD;
    --gris: #F5F7FA;
    --blanco: #FFFFFF;
    --texto: #1E1E2F;
    --sombra: rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--gris);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  header {
    background: var(--azul);
    color: white;
    padding: 20px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }

  main { display: flex; flex: 1; overflow: hidden; }
  aside {
    width: 280px;
    background: var(--blanco);
    border-right: 1px solid #ddd;
    padding: 25px;
  }

  aside h2 { color: var(--azul); font-size: 1.2em; margin-bottom: 10px; }
  aside ul { list-style: none; padding: 0; margin-top: 10px; }
  aside li {
    margin-bottom: 10px;
    color: #444;
    cursor: pointer;
    padding: 8px 10px;
    border-radius: 6px;
  }
  aside li:hover, aside li.active { background: var(--cian); color: white; }

  .chat-container { flex: 1; display: flex; flex-direction: column; padding: 20px; }
  .chat-box {
    flex: 1;
    background: var(--blanco);
    border-radius: 12px;
    box-shadow: 0 4px 10px var(--sombra);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .chat-header { background: var(--cian); color: white; padding: 15px 20px; font-weight: 500; }

  .messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: #f9fbff;
  }

  .msg {
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.5;
    font-size: 0.95em;
    animation: fadeIn 0.3s ease;
    word-break: break-word;
  }
  .msg.user { align-self: flex-end; background: var(--cian); color: white; }
  .msg.bot { align-self: flex-start; background: #ebedff; color: #222; }
  .msg.bot table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 8px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 6px var(--sombra);
  }
  .msg.bot th {
    background: var(--azul);
    color: white;
    padding: 8px;
    font-size: 0.9em;
  }
  .msg.bot td {
    border-top: 1px solid #ddd;
    padding: 8px;
    font-size: 0.9em;
  }
  .msg.bot tr:nth-child(even) td { background: #f2f5ff; }

  .input-area {
    display: flex;
    align-items: center;
    padding: 10px;
    border-top: 1px solid #ddd;
    background: #fff;
  }
  input {
    flex: 1;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    outline: none;
    font-size: 0.95em;
  }
  input:focus { border-color: var(--cian); }

  button {
    background: var(--azul);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 14px;
    margin-left: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.25s;
  }
  button:hover { background: var(--violeta); }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  footer { text-align: center; padding: 10px; background: #fff; font-size: 0.9em; color: #666; }
</style>
</head>
<body>

<header>
  üè• Asistente Cl√≠nico Inteligente
  <span>v2.0 ‚Äî Cohortes con Memoria</span>
</header>

<main>
  <aside>
    <h2>Secciones</h2>
    <ul>
      <li class="active" onclick="switchSection('consulta', event)">Consulta Cl√≠nica</li>
      <li onclick="switchSection('cohortes', event)">An√°lisis de Cohortes</li>
      <li onclick="switchSection('riesgo', event)">Factores de Riesgo</li>
      <li onclick="switchSection('exportacion', event)">Exportaci√≥n / Informe</li>
    </ul>
  </aside>

  <section class="chat-container">
    <div class="chat-box">
      <div id="chatHeader" class="chat-header">Consulta Cl√≠nica</div>
      <div id="messages" class="messages"></div>
      <div class="input-area">
        <input id="userInput" placeholder="Ej: pacientes con diabetes tipo 2 y obesidad..." onkeypress="if(event.key==='Enter') sendText()">
        <button onclick="sendText()"><i data-lucide='send'></i></button>
      </div>
    </div>
  </section>
</main>

<footer>¬© 2025 Asistente Cl√≠nico Inteligente ‚Äî Proyecto Datathon Dedalus</footer>

<script>
lucide.createIcons();

// === Configuraci√≥n ===
const webhooks = {
  consulta: "https://rubaseval.app.n8n.cloud/webhook-test/dedaluschataudio",
  cohortes: "https://rubaseval.app.n8n.cloud/webhook/dedaluscohortes",
  riesgo: "https://rubaseval.app.n8n.cloud/webhook/dedalusriesgo",
  exportacion: "https://rubaseval.app.n8n.cloud/webhook/dedalusexportacion"
};

let currentSection = "consulta";
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("userInput");

// === Memoria persistente por secci√≥n ===
const memory = JSON.parse(sessionStorage.getItem("memory") || "{}");
if (!memory[currentSection]) memory[currentSection] = [];

loadHistory();

// === Cambio de secci√≥n ===
function switchSection(section, ev) {
  saveHistory();
  currentSection = section;
  document.querySelectorAll("aside li").forEach(li => li.classList.remove("active"));
  ev.target.classList.add("active");
  document.getElementById("chatHeader").innerText = ev.target.innerText;
  loadHistory();
}

// === Cargar historial de sesi√≥n ===
function loadHistory() {
  messagesDiv.innerHTML = "";
  const history = memory[currentSection] || [];
  history.forEach(msg => appendMessage(msg.sender, msg.html));
  if (history.length === 0)
    appendMessage("bot", `<p>Has abierto la secci√≥n <b>${currentSection}</b>. Pregunta lo que necesites.</p>`);
}

// === Guardar historial de sesi√≥n ===
function saveHistory() {
  sessionStorage.setItem("memory", JSON.stringify(memory));
}

// === Env√≠o de texto ===
async function sendText() {
  const text = input.value.trim();
  if (!text) return;
  appendMessage("user", text);
  input.value = "";
  appendMessage("bot", "<em>Procesando...</em>", true);

  memory[currentSection].push({ sender: "user", html: text });
  saveHistory();

  try {
    const context = memory[currentSection]
      .map(m => `${m.sender === 'user' ? 'Usuario' : 'Asistente'}: ${m.html.replace(/<[^>]*>?/gm, '')}`)
      .join('\n');

    const res = await fetch(webhooks[currentSection], {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        type: "text",
        content: `Contexto previo:\n${context}\n\nNueva entrada del usuario:\n${text}`
      })
    });

    const data = await res.json();
    removeLoading();
    const reply = data.output || "‚ö†Ô∏è No se recibi√≥ respuesta.";
    memory[currentSection].push({ sender: "bot", html: reply });
    appendMessage("bot", parseMarkdown(reply));
    saveHistory();
  } catch (err) {
    removeLoading();
    appendMessage("bot", "‚ö†Ô∏è Error al conectar con el asistente.");
    console.error(err);
  }
}

// === Renderizado de mensajes ===
function appendMessage(sender, html, isLoading=false) {
  const msg = document.createElement("div");
  msg.className = "msg " + sender;
  msg.innerHTML = html;
  if (isLoading) msg.id = "loading";
  messagesDiv.appendChild(msg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  if (!isLoading) saveHistory();
}

// === Limpieza del mensaje "Procesando" ===
function removeLoading() {
  const loading = document.getElementById("loading");
  if (loading) loading.remove();
}

// === Parser Markdown a HTML con tablas ===
function parseMarkdown(md) {
  if (md.includes("|")) {
    md = md.replace(/^\|(.+)\|\n\|([-:| ]+)\|\n((\|.*\|\n?)*)/gm, (m, h, s, r) => {
      const header = h.split("|").map(h => `<th>${h.trim()}</th>`).join("");
      const rows = r.trim().split("\n").map(row => {
        const cells = row.split("|").map(c => `<td>${c.trim()}</td>`).join("");
        return `<tr>${cells}</tr>`;
      }).join("");
      return `<table><tr>${header}</tr>${rows}</table>`;
    });
  }
  return md
    .replace(/^### (.*$)/gim, "<h3>$1</h3>")
    .replace(/^## (.*$)/gim, "<h2>$1</h2>")
    .replace(/^# (.*$)/gim, "<h1>$1</h1>")
    .replace(/\*\*(.*?)\*\*/gim, "<strong>$1</strong>")
    .replace(/\n\n/g, "</p><p>")
    .replace(/\n/g, "<br>");
}
</script>
</body>
</html>
